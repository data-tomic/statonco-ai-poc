<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatOnco PoC (–≠—Ç–∞–ø 3: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
     <style>
        .dataframe { width: auto; max-width: 100%; margin-bottom: 1rem; }
        .img-fluid { max-width: 100%; height: auto; display: block; margin: 1rem auto; }
        .alert { word-wrap: break-word; }
        .result-step { border: 1px solid #dee2e6; border-radius: .25rem; margin-bottom: 1.5rem; }
        .result-step .card-header { background-color: rgba(0,0,0,.03); }
    </style>
</head>
<body>
     <nav class="navbar navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                üî¨ StatOnco PoC: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ê–Ω–∞–ª–∏–∑
            </a>
        </div>
    </nav>
     <div class="container">
         <!-- Flash —Å–æ–æ–±—â–µ–Ω–∏—è -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message | safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

          <h2>–≠—Ç–∞–ø 3: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>
          <hr>

          <a href="{{ url_for('index') }}" class="btn btn-secondary mb-3">‚Üê –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</a>

         {% if analysis_results %}
             {% for step_result in analysis_results %}
                 <div class="card result-step">
                     <div class="card-header">
                         –®–∞–≥: <strong>{{ step_result.plan.get('analysis_type', 'N/A') }}</strong>
                         {% if step_result.status == 'success' %}
                            <span class="badge bg-success float-end">–£—Å–ø–µ—Ö</span>
                         {% elif step_result.status == 'error' %}
                             <span class="badge bg-danger float-end">–û—à–∏–±–∫–∞</span>
                         {% else %}
                             <span class="badge bg-secondary float-end">{{ step_result.status }}</span>
                         {% endif %}
                     </div>
                     <div class="card-body">
                         {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–ª–∞–Ω–∞ —ç—Ç–æ–≥–æ —à–∞–≥–∞ #}
                         <details class="mb-2">
                            <summary class="text-muted" style="cursor: pointer;">–î–µ—Ç–∞–ª–∏ –ø–ª–∞–Ω–∞ —ç—Ç–æ–≥–æ —à–∞–≥–∞...</summary>
                            <pre><code class="language-json">{{ step_result.plan | tojson(indent=2) }}</code></pre>
                         </details>

                         {% if step_result.status == 'error' %}
                            <div class="alert alert-danger mb-0">
                                {{ step_result.get('message', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —ç—Ç–æ–≥–æ —à–∞–≥–∞.') }}
                            </div>
                            {% if step_result.data and step_result.data.table_html %} {# –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤–µ—Ä–Ω—É–ª–∞ —Ç–∞–±–ª–∏—Ü—É #}
                               <div class="mt-3">
                                   <p class="text-muted small">–î–∞–Ω–Ω—ã–µ, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ—à–∏–±–∫–æ–π (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ):</p>
                                   <div class="table-responsive">{{ step_result.data.table_html | safe }}</div>
                               </div>
                            {% endif %}
                         {% elif step_result.status == 'success' %}
                             {% set data = step_result.get('data', {}) %} {# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ stats_processor #}

                             {# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ #}
                             {% if data.metrics %}
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                {% for key, value in data.metrics.items() %}
                                    <div class="border p-2 rounded bg-light small">
                                        <strong>{{ key }}:</strong> {{ value }}
                                    </div>
                                {% endfor %}
                                </div>
                             {% endif %}

                              {# –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è #}
                             {% if data.interpretation %}
                                <div class="alert {{ 'alert-info' if not data.get('significance') else 'alert-primary' }}">{{ data.interpretation }}</div>
                             {% endif %}
                             {% if data.warning %}
                                <div class="alert alert-warning"><strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> {{ data.warning }}</div>
                             {% endif %}

                             {# –¢–∞–±–ª–∏—Ü–∞ #}
                             {% if data.table_html %}
                                <div class="mt-3">
                                     <h5>{{ "–¢–∞–±–ª–∏—Ü–∞ —Å–æ–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç–∏" if data.get('test_type') == "–¢–µ—Å—Ç –•–∏-–∫–≤–∞–¥—Ä–∞—Ç –ü–∏—Ä—Å–æ–Ω–∞" else "–û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"}}</h5>
                                    <div class="table-responsive">
                                      {{ data.table_html | safe }}
                                    </div>
                                </div>
                             {% endif %}

                              {# –ì—Ä–∞—Ñ–∏–∫ #}
                             {% if data.plot_data %}
                                <div class="mt-4 text-center">
                                    <h5>–ì—Ä–∞—Ñ–∏–∫</h5>
                                    <img src="{{ data.plot_data }}" alt="–ì—Ä–∞—Ñ–∏–∫ –¥–ª—è —à–∞–≥–∞ {{ loop.index }}" class="img-fluid border rounded">
                                </div>
                             {% endif %}
                         {% else %}
                              <div class="alert alert-secondary">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —à–∞–≥–∞ (—Å—Ç–∞—Ç—É—Å: {{ step_result.status }}).</div>
                         {% endif %}
                     </div>
                 </div>
             {% endfor %}
         {% else %}
             <div class="alert alert-warning">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>
         {% endif %}

     </div>

    <footer class="mt-5 text-center text-muted">
        <hr>
        <p>StatOnco PoC v0.4 (–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π)</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {# –°—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å JS –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ JSON, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ #}
</body>
</html>
