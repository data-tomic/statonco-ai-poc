<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatOnco PoC (–≠—Ç–∞–ø 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞–Ω–∞)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
     <style>
         /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞ */
        .spinner-border { width: 3rem; height: 3rem; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 1050; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>
    <nav class="navbar navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                üî¨ StatOnco PoC: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ê–Ω–∞–ª–∏–∑
            </a>
        </div>
    </nav>

    <div class="container">
         <!-- Flash —Å–æ–æ–±—â–µ–Ω–∏—è -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message | safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <h2>–≠—Ç–∞–ø 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∞–Ω–∞–ª–∏–∑–∞</h2>
        <hr>

        <div class="card">
            <div class="card-header">
                –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π LLM –ø–ª–∞–Ω –∞–Ω–∞–ª–∏–∑–∞
            </div>
            <div class="card-body">
                 {% if proposed_plan %}
                    {% if proposed_plan is mapping and proposed_plan.error %} {# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –æ—Ç LLM #}
                         <div class="alert alert-danger">
                             <strong>–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ LLM:</strong> {{ proposed_plan.error }}
                             {% if proposed_plan.raw_response %} <hr> <pre><code>{{ proposed_plan.raw_response }}</code></pre> {% endif %}
                         </div>
                         <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                    {% elif proposed_plan is iterable and proposed_plan is not string and proposed_plan is not mapping %}
                         <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —à–∞–≥–∏ –∞–Ω–∞–ª–∏–∑–∞. –ï—Å–ª–∏ –≤—Å–µ –≤–µ—Ä–Ω–æ, –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å".</p>
                         <ul class="list-group">
                             {% for step in proposed_plan %}
                                 <li class="list-group-item">
                                     <strong>–¢–∏–ø:</strong> {{ step.get('analysis_type', 'N/A') }}<br>
                                     {% if step.get('analysis_type') == 't-test' %}
                                         –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è: <code>{{ step.get('variable', '???') }}</code><br>
                                         –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: <code>{{ step.get('grouping_variable', '???') }}</code>
                                     {% elif step.get('analysis_type') == 'chi-square' %}
                                          –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è 1: <code>{{ step.get('variable1', '???') }}</code><br>
                                          –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è 2: <code>{{ step.get('variable2', '???') }}</code>
                                     {% elif step.get('analysis_type') == 'descriptive_stats' %}
                                          –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è: <code>{{ step.get('variable', '???') }}</code>
                                     {% elif step.get('analysis_type') == 'error' %}
                                          <strong class="text-danger">–ü—Ä–æ–±–ª–µ–º–∞:</strong> {{ step.get('message', '–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π') }}
                                     {% else %}
                                         <em>(–î–µ—Ç–∞–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞)</em>
                                     {% endif %}
                                 </li>
                             {% endfor %}
                         </ul>
                         <form method="POST" action="{{ url_for('execute_plan') }}" class="mt-4" id="execute-plan-form">
                             <button type="submit" class="btn btn-success w-100">
                                 ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                             </button>
                             <!-- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –∏–ª–∏ "–û—Ç–∫–ª–æ–Ω–∏—Ç—å", –Ω–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω–∏—Ç –ª–æ–≥–∏–∫—É -->
                             <a href="{{ url_for('index') }}" class="btn btn-link w-100 mt-2">–û—Ç–º–µ–Ω–∏—Ç—å –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                         </form>
                    {% else %}
                         <div class="alert alert-warning">–ü–æ–ª—É—á–µ–Ω –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–ª–∞–Ω–∞ –æ—Ç LLM. –ù–µ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π.</div>
                         <pre><code>{{ proposed_plan | tojson(indent=2) }}</code></pre>
                         <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                    {% endif %}
                 {% else %}
                    <div class="alert alert-danger">–ù–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞–Ω –∞–Ω–∞–ª–∏–∑–∞ –≤ —Å–µ—Å—Å–∏–∏.</div>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                 {% endif %}
            </div>
        </div>

         <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —à–∞–≥–∞ -->
         <div class="loading-overlay" id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="ms-2 mt-2">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</p>
        </div>

    </div>

    <footer class="mt-5 text-center text-muted">
        <hr>
        <p>StatOnco PoC v0.4 (–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π)</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
     <script>
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        document.getElementById('execute-plan-form').addEventListener('submit', function() {
             document.getElementById('loading-spinner').style.display = 'flex';
        });
    </script>
</body>
</html>
