<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatOnco PoC (–≠—Ç–∞–ø 1: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .dataframe { width: auto; max-width: 100%; margin-bottom: 1rem; font-size: 0.9em; } /* –£–º–µ–Ω—å—à–∏–ª —à—Ä–∏—Ñ—Ç —Ç–∞–±–ª–∏—Ü—ã */
        .column-list-group { max-height: 400px; overflow-y: auto; } /* –°–∫—Ä–æ–ª–ª –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ */
         /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞ */
        .spinner-border { width: 3rem; height: 3rem; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 1050; justify-content: center; align-items: center; flex-direction: column; }
        .list-group-item { display: flex; align-items: center; } /* –î–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ –∏ —Ç–µ–∫—Å—Ç–∞ */
        .list-group-item .form-check-input { margin-top: 0; margin-right: 0.5rem !important;} /* –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç—Å—Ç—É–ø–∞ —á–µ–∫–±–æ–∫—Å–∞ */
        .list-group-item .text-muted, .list-group-item .text-success { margin-left: auto; /* –ü—Ä–∏–∂–∞—Ç—å % –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */ white-space: nowrap; /* –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–µ—Ä–µ–Ω–æ—Å */}
    </style>
</head>
<body>
    <nav class="navbar navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                üî¨ StatOnco PoC: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ê–Ω–∞–ª–∏–∑
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- Flash —Å–æ–æ–±—â–µ–Ω–∏—è -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message | safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <h2>–≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞</h2>
        <hr>

        <div class="row">
            <div class="col-lg-5 mb-3"> {# –ò–∑–º–µ–Ω–∏–ª –Ω–∞ lg –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–¥–∞ –Ω–∞ —Å—Ä–µ–¥–Ω–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö #}
                <h4>–ê–Ω–∞–ª–∏–∑ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö:</h4>
                {# –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML –∏–∑ —Å–µ—Å—Å–∏–∏, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –∫–∞–∫ completeness_html #}
                {% if completeness_html %}
                    <div class="table-responsive">
                         {{ completeness_html | safe }}
                    </div>
                {% else %}
                    <div class="alert alert-secondary">–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ—Ç—á–µ—Ç –æ –ø–æ–ª–Ω–æ—Ç–µ –¥–∞–Ω–Ω—ã—Ö.</div>
                {% endif %}

                <h4 class="mt-4">–í–∞—à –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å:</h4>
                <div class="card">
                    <div class="card-body bg-light">
                        <p class="card-text"><em>{{ original_query }}</em></p>
                    </div>
                </div>
            </div>

            <div class="col-lg-7"> {# –ò–∑–º–µ–Ω–∏–ª –Ω–∞ lg #}
                <form method="POST" action="{{ url_for('confirm_columns') }}" id="confirm-columns-form">
                    <h4>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è LLM:</h4>
                    {% if llm_suggestions %}
                         {% if llm_suggestions.error %}
                            <div class="alert alert-danger">
                                <strong>–û—à–∏–±–∫–∞ LLM –Ω–∞ —ç—Ç–∞–ø–µ –æ—Ü–µ–Ω–∫–∏:</strong> {{ llm_suggestions.error }}
                                {% if llm_suggestions.raw_response %} <hr> <pre><code>{{ llm_suggestions.raw_response }}</code></pre> {% endif %}
                                <p>–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å. <a href="{{ url_for('index') }}">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</a>.</p>
                            </div>
                            {# –§–æ—Ä–º–∞ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –∏–ª–∏ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∏–∂–µ #}
                         {% else %}
                            {# –≠—Ç–∞ —á–∞—Å—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–∫–∏ LLM #}
                            <div class="mb-3">
                                <label class="form-label"><strong>–°—Ç–æ–ª–±—Ü—ã, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ LLM –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</strong> (–æ—Ç–º–µ—Ç—å—Ç–µ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å):</label>
                                <div class="list-group column-list-group border rounded p-2">
                                    {% if all_columns %} {# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–ø–∏—Å–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ –µ—Å—Ç—å #}
                                        {# --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º report_df, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ render_template --- #}
                                        {% set report_data = report_df.set_index('–°—Ç–æ–ª–±–µ—Ü') if report_df is not none and not report_df.empty else none %}
                                        {# --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø --- #}

                                        {% for col in all_columns %}
                                            <label class="list-group-item">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       name="confirmed_columns"
                                                       value="{{ col }}"
                                                       {% if col in llm_suggestions.get('suggested_columns', []) %}checked{% endif %}> <!-- –û—Ç–º–µ—á–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ -->
                                                {{ col }}
                                                {# --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º report_data --- #}
                                                {% if report_data is not none and col in report_data.index %} {# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ #}
                                                    {% set col_completeness = report_data.loc[col, '% –ø—Ä–æ–ø—É—Å–∫–æ–≤'] %} {# –ü–æ–ª—É—á–∞–µ–º % –ø—Ä–æ–ø—É—Å–∫–æ–≤ #}
                                                    {% if col_completeness > 0 %}
                                                        <small class="text-muted">({{ "%.1f"|format(col_completeness) }}% –ø—Ä–æ–ø.)</small> {# –°–æ–∫—Ä–∞—Ç–∏–ª —Ç–µ–∫—Å—Ç #}
                                                    {% elif col_completeness == 0 %}
                                                         <small class="text-success">(0% –ø—Ä–æ–ø.)</small>
                                                    {% endif %}
                                                {% endif %}
                                                {# --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø --- #}
                                            </label>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted p-2">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>
                                    {% endif %} {# end if all_columns #}
                                </div>
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.</div>
                            </div>

                            {% if llm_suggestions.get('questions_to_user') %}
                                <div class="mb-3">
                                    <label for="clarifications" class="form-label"><strong>–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç LLM:</strong></label>
                                    <div class="alert alert-info">
                                        <ul>
                                        {% for question in llm_suggestions.questions_to_user %}
                                            <li>{{ question }}</li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                    {# –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ #}
                                    <textarea class="form-control" id="clarifications" name="clarifications" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è...">{{ user_clarifications_input or '' }}</textarea>
                                    <div class="form-text">–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–º–æ–≥—É—Ç LLM —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–Ω—ã–π –ø–ª–∞–Ω –∞–Ω–∞–ª–∏–∑–∞.</div>
                                </div>
                            {% else %}
                                 <p class="text-muted">LLM –Ω–µ –∑–∞–¥–∞–ª–∞ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.</p>
                                 <input type="hidden" name="clarifications" value=""> {# –ü—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç #}
                            {% endif %}

                            <button type="submit" class="btn btn-primary w-100 mt-3">
                                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å—Ç–æ–ª–±—Ü—ã –∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω –∞–Ω–∞–ª–∏–∑–∞ ‚Üí
                            </button>

                         {% endif %} {# end if not llm_suggestions.error #}
                    {% else %}
                         <div class="alert alert-warning">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç LLM. <a href="{{ url_for('index') }}">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</a>.</div>
                    {% endif %} {# end if llm_suggestions #}
                </form>
            </div>
        </div>

         <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ -->
         <div class="loading-overlay" id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="ms-2 mt-2">–ó–∞–ø—Ä–æ—Å –ø–ª–∞–Ω–∞ –∞–Ω–∞–ª–∏–∑–∞ —É LLM...</p>
        </div>

    </div>

    <footer class="mt-5 text-center text-muted">
        <hr>
        <p>StatOnco PoC v0.4.1 (–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π)</p> {# –û–±–Ω–æ–≤–∏–ª –≤–µ—Ä—Å–∏—é #}
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
     <script>
        document.getElementById('confirm-columns-form').addEventListener('submit', function(event) {
            // –ü—Ä–æ–≤–µ—Ä–∏–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω —Å—Ç–æ–ª–±–µ—Ü
             const checkboxes = document.querySelectorAll('input[name="confirmed_columns"]:checked');
             if (checkboxes.length === 0) {
                 alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.');
                 event.preventDefault(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
                 return;
             }
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
             document.getElementById('loading-spinner').style.display = 'flex';
        });
    </script>
</body>
</html>
